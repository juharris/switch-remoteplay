<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Switch Remoteplay</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"
			integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"
			integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<style type="text/css">
		body {
			background: #333;
			color: #ddd;
		}

		div.connection-status,
		div.send-mode-status,
		div.status {
			min-height: 30px;
		}
	</style>
	<script type="text/javascript" charset="utf-8">
        let socket
        let isInSendMode = false

        function updateConnectionStatus(status) {
            $('#connection-status').text(status)
            console.debug(status)
        }

        $(document).ready(function () {
            const queryString = window.location.search
            const urlParams = new URLSearchParams(queryString)
            const address = urlParams.get('a') || 'http://127.0.0.1:5000'
            const status = `Connecting to "${address}"...`
            updateConnectionStatus(status)
            socket = io(address)

            isInSendMode = urlParams.get('s') === 'true'
            checkSendMode()

            socket.on('connect', function (data) {
                $('#connection-status').text("✅ Connected")
                console.log(data)
            })

            socket.on('disconnect', function () {
                $('#connection-status').text("❌ Disconnected")
                console.warn("Disconnected")
            })
        })

        function sendCommand(command) {
            $('#status').text(`emitting ${command}`)
            socket.emit('p', command, (data) => {
                $('#status').text("p responded: " + data)
            })
        }


        const keyMap = {
            ArrowLeft: {
                down: 'left d',
                up: 'left u',
            },
            ArrowRight: {
                down: 'right d',
                up: 'right u',
            },
            ArrowUp: {
                down: 'up d',
                up: 'up u',
            },
            ArrowDown: {
                down: 'down d',
                up: 'down u',
            },
            KeyA: {
                down: 's l left',
                up: 's l center',
            },
            KeyD: {
                down: 's l right',
                up: 's l center',
            },
            KeyS: {
                down: 's l down',
                up: 's l center',
            },
            KeyW: {
                down: 's l up',
                up: 's l center',
            },
            Space: {
                down: 'b d',
                up: 'b u',
            },
            KeyE: {
                down: 'x d',
                up: 'x u',
            },
            KeyQ: {
                down: 'y d',
                up: 'y u',
            },
        }

        document.addEventListener('keydown', function (e) {
            if (!isInSendMode) {
                return
            }
            const command = keyMap[e.code]
            if (command) {
                sendCommand(command.down)
                e.preventDefault()
            } else if (!(e.code in keyMappingPress) && !(e.code in keyMappingOnUp)) {
                console.warn(`keydown: Unknown command: ${e.code}`)
            }

        })
        document.addEventListener('keyup', function (e) {
            if (!isInSendMode) {
                return
            }
            const command = keyMap[e.code]
            if (command) {
                sendCommand(command.up)
                e.preventDefault()
            } else if (!(e.code in keyMappingOnDown) && !(e.code in keyMappingPress)) {
                console.warn(`keyup: Unknown command: ${e.code}`)
            }
        })

        document.addEventListener('keypress', function (e) {
        })

        document.onclick = function (e) {
            if (e.target.id === 'send-mode-toggle') {
                return
            }
            if (!isInSendMode) {
                return
            }
            sendCommand('a')
            e.preventDefault()
        }

        function toggleSendMode() {
            isInSendMode = !isInSendMode
            checkSendMode()
        }

        function checkSendMode() {
            if (isInSendMode) {
                $('#send-mode-status').text("✅ Enabled")
                $('#send-mode-toggle').text("Disable Sending Commands")
            } else {
                $('#send-mode-status').text("❌ Disabled")
                $('#send-mode-toggle').text("Start Sending Commands")
            }
        }
	</script>
</head>

<body>
<div class="connection-status">
	Connection status: <span id="connection-status"></span>
</div>
<div class="send-mode-status">
	Send mode: <span id="send-mode-status"></span>
<!--</div>-->
<!--<div>-->
	<button id="send-mode-toggle" onclick="toggleSendMode()">Start Sending Commands</button>
</div>
<div class="status">
	Status: <span id="status"></span>
</div>
</body>

</html>